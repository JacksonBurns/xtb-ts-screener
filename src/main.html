<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>XTBTSScreener.jl - Screening Likely Transition States with Julia and Machine Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="main_files/libs/clipboard/clipboard.min.js"></script>
<script src="main_files/libs/quarto-html/quarto.js"></script>
<script src="main_files/libs/quarto-html/popper.min.js"></script>
<script src="main_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="main_files/libs/quarto-html/anchor.min.js"></script>
<link href="main_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="main_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="main_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="main_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="main_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><code>XTBTSScreener.jl</code> - Screening Likely Transition States with Julia and Machine Learning</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This Jupyter notebook demonstrates the use of machine learning to predict if a partially-optimized initialization of a transition state, used in the study of chemical kinetics to predict rate constants, is <em>“likely to converge”</em> or not after further simulation with expensive Density Functional Theory simulations.</p>
<p>It includes a step-by-step breakdown of loading the data, training the model, and evaluating the performance. This notebook draws heavily from the Lux LSTM example <a href="https://lux.csail.mit.edu/stable/examples/generated/beginner/SimpleRNN/main/">found here</a>.</p>
<p><em>Developed April 2023 by Jackson Burns for the Final Project in MIT 18.337: Parallel Computing and Scientific Machine Learning</em></p>
<section id="load-the-data" class="level2">
<h2 class="anchored" data-anchor-id="load-the-data">Load the Data</h2>
<p>The input data is saved in a CSV file, which was exported from a large SQL database of simulation results. We can load it using <code>CSV.jl</code> and then partition the data into training and testing sets using <code>MLUtils.jl</code>.</p>
<p>At this moment in time the dataset is highly <em>unbalanced</em> due to limitations in post-processing speed of simulations hindering retrieval of failed examples. To reduce the impact of this phenomemon on the study, we will downsample the data to a 50:50 split of failed and converged samples.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MLUtils</span>, <span class="bu">CSV</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>csv_reader <span class="op">=</span> CSV.<span class="fu">File</span>(<span class="st">"data/roo_co2_full_data_augmented_expanded.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> <span class="fl">20501</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># keep track of number of failed and converged to balance the dataset</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>number_converged <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>number_failed <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate through the entire dataset</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> csv_reader[<span class="fl">1</span><span class="op">:</span>n_samples]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check the label</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">parse</span>(<span class="dt">Bool</span>, <span class="st">"</span><span class="sc">$</span>(row.converged)<span class="st">"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        number_converged <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        number_failed <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>smaller_label <span class="op">=</span> <span class="fu">minimum</span>([number_converged, number_failed])</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Failed: </span><span class="sc">$</span>number_failed<span class="sc">\n</span><span class="st">"</span> <span class="op">*</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Converged: </span><span class="sc">$</span>number_converged<span class="sc">\n</span><span class="st">"</span> <span class="op">*</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Keep: </span><span class="sc">$</span>smaller_label<span class="st">"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Failed: 3274
Converged: 17227
Keep: 3274</code></pre>
</div>
</div>
<p>Each row in the CSV will have the a matrix of spatial coordinates for the molecule and the Gibbs free energy, <span class="math inline">\(E_{0}+ZPE\)</span>(sum of electronic total energy and zero point energy), and number of simulation steps for each of the three substeps in the optimization. Initial modeling results using only the coordinate arrays were unsuccessful, with models never seeing improvement in accuracy beyond randomly guessing. These augmented descriptors have shown to improve model performance over that baseline.</p>
<p>Each sample in the system represents a different chemical reaction and it can therefore have a different number of atoms. The most that any molecule has will not exceed 55, so to leave room for growth and other descriptors we will zero pad each sample to a uniform length.</p>
<p>The exact mechanisms by which this function work are described in the inline comments, but just know that it involves a lot of string to float casting.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">get_dataloaders</span>(smaller_label)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    csv_reader <span class="op">=</span> CSV.<span class="fu">File</span>(<span class="st">"data/roo_co2_full_data_augmented_expanded.csv"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="fl">20501</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    x_data <span class="op">=</span> <span class="fu">Array</span><span class="dt">{Float32}</span>(<span class="cn">undef</span>, <span class="fl">60</span>, <span class="fl">6</span>, smaller_label <span class="op">*</span> <span class="fl">2</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> <span class="dt">Float32</span>[]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    iter <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Progress:"</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep track of number of failed to balance the dataset</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    number_converged <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    number_failed <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> csv_reader[<span class="fl">1</span><span class="op">:</span>n_samples]</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print some updates as we go</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">mod</span>(iter, <span class="fu">div</span>(n_samples, <span class="fl">10</span>)) <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">println</span>(<span class="st">" - row </span><span class="sc">$</span>iter<span class="st"> of </span><span class="sc">$</span>smaller_label<span class="st">"</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">flush</span>(<span class="cn">stdout</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get if it converged or not, add alternating samples</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">parse</span>(<span class="dt">Bool</span>, <span class="st">"</span><span class="sc">$</span>(row.converged)<span class="st">"</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> number_converged <span class="op">&lt;</span> number_failed</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                <span class="fu">push!</span>(labels, <span class="fl">1.0f0</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                number_converged <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">push!</span>(labels, <span class="fl">0.0f0</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>            number_failed <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># array for descriptors for this transition state</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> <span class="fu">Array</span><span class="dt">{Float32}</span>(<span class="cn">undef</span>, <span class="fl">60</span>, <span class="fl">6</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># pull out the augmented descriptors</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        split_gibbs <span class="op">=</span> <span class="fu">split</span>(<span class="st">"</span><span class="sc">$</span>(row.gibbs)<span class="st">"</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        split_steps <span class="op">=</span> <span class="fu">split</span>(<span class="st">"</span><span class="sc">$</span>(row.steps)<span class="st">"</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        split_e0_zpe <span class="op">=</span> <span class="fu">split</span>(<span class="st">"</span><span class="sc">$</span>(row.e0_zpe)<span class="st">"</span>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        split_descriptors <span class="op">=</span> [split_gibbs, split_steps, split_e0_zpe]</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>                temp <span class="op">=</span> <span class="fu">String</span>(split_descriptors[i][j])</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                temp <span class="op">=</span> <span class="fu">replace</span>(temp, <span class="st">"]"</span> <span class="op">=&gt;</span> <span class="st">""</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>                temp <span class="op">=</span> <span class="fu">replace</span>(temp, <span class="st">"["</span> <span class="op">=&gt;</span> <span class="st">""</span>)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>                temp <span class="op">=</span> <span class="fu">replace</span>(temp, <span class="st">","</span> <span class="op">=&gt;</span> <span class="st">""</span>)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>                m[i, j] <span class="op">=</span> <span class="fu">parse</span>(<span class="dt">Float32</span>, temp)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            m[i, <span class="fl">4</span>] <span class="op">=</span> <span class="fu">Float32</span>(<span class="fl">0.0</span>)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>            m[i, <span class="fl">5</span>] <span class="op">=</span> <span class="fu">Float32</span>(<span class="fl">0.0</span>)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>            m[i, <span class="fl">6</span>] <span class="op">=</span> <span class="fu">Float32</span>(<span class="fl">0.0</span>)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the final coordinates of the atoms</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        split_array <span class="op">=</span> <span class="fu">split</span>(<span class="st">"</span><span class="sc">$</span>(row.std_xyz)<span class="st">"</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        n_atoms <span class="op">=</span> <span class="fu">Int</span>(<span class="fu">length</span>(split_array) <span class="op">/</span> <span class="fl">6</span>)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        row_counter <span class="op">=</span> <span class="fl">4</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        column_counter <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> value <span class="kw">in</span> split_array</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>            temp <span class="op">=</span> <span class="fu">String</span>(value)</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>            temp <span class="op">=</span> <span class="fu">replace</span>(temp, <span class="st">"]"</span> <span class="op">=&gt;</span> <span class="st">""</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            temp <span class="op">=</span> <span class="fu">replace</span>(temp, <span class="st">"["</span> <span class="op">=&gt;</span> <span class="st">""</span>)</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            temp <span class="op">=</span> <span class="fu">replace</span>(temp, <span class="st">","</span> <span class="op">=&gt;</span> <span class="st">""</span>)</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>            m[row_counter, column_counter] <span class="op">=</span> <span class="fu">parse</span>(<span class="dt">Float32</span>, temp)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>            column_counter <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> column_counter <span class="op">&gt;</span> <span class="fl">6</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>                column_counter <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>                row_counter <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># zero-padding</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> n_atoms<span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="fl">60</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>            m[i, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>] <span class="op">=</span> [<span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>]</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        x_data[<span class="fl">1</span><span class="op">:</span><span class="fl">60</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, iter] <span class="op">=</span> m</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        iter <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    remainingsamples <span class="op">=</span> <span class="fu">length</span>(labels)</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"downsampled to </span><span class="sc">$</span>remainingsamples<span class="st"> samples, </span><span class="sc">$</span>number_converged<span class="st"> converged </span><span class="sc">$</span>number_failed<span class="st"> failed"</span>)</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"...loading done, partitioning data."</span>)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    (x_train, y_train), (x_val, y_val) <span class="op">=</span> <span class="fu">splitobs</span>((x_data, labels); at<span class="op">=</span><span class="fl">0.8</span>, shuffle<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="fu">DataLoader</span>(<span class="fu">collect</span>.((x_train, y_train)); batchsize<span class="op">=</span><span class="fl">2</span><span class="op">^</span><span class="fl">6</span>, shuffle<span class="op">=</span><span class="cn">true</span>),</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        <span class="fu">DataLoader</span>(<span class="fu">collect</span>.((x_val, y_val)); batchsize<span class="op">=</span><span class="fl">2</span><span class="op">^</span><span class="fl">6</span>, shuffle<span class="op">=</span><span class="cn">false</span>))</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>get_dataloaders (generic function with 1 method)</code></pre>
</div>
</div>
<p>For ease of debugging and as a reference, the original tutorial dataloading function is included below.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">get_tutorial_dataloaders</span>()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    dataset_size <span class="op">=</span> <span class="fl">1000</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    sequence_length <span class="op">=</span> <span class="fl">50</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> [MLUtils.Datasets.<span class="fu">make_spiral</span>(sequence_length) for _ <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>dataset_size]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the labels</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> <span class="fu">vcat</span>(<span class="fu">repeat</span>([<span class="fl">0.0f0</span>], dataset_size <span class="op">÷</span> <span class="fl">2</span>), <span class="fu">repeat</span>([<span class="fl">1.0f0</span>], dataset_size <span class="op">÷</span> <span class="fl">2</span>))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    clockwise_spirals <span class="op">=</span> [<span class="fu">reshape</span>(d[<span class="fl">1</span>][<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span>sequence_length], <span class="op">:</span>, sequence_length, <span class="fl">1</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                         for d <span class="kw">in</span> data[<span class="fl">1</span><span class="op">:</span>(dataset_size<span class="op">÷</span><span class="fl">2</span>)]]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    anticlockwise_spirals <span class="op">=</span> [<span class="fu">reshape</span>(d[<span class="fl">1</span>][<span class="op">:</span>, (sequence_length<span class="op">+</span><span class="fl">1</span>)<span class="op">:</span><span class="kw">end</span>], <span class="op">:</span>, sequence_length,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1</span>) for d <span class="kw">in</span> data[((dataset_size<span class="op">÷</span><span class="fl">2</span>)<span class="op">+</span><span class="fl">1</span>)<span class="op">:</span><span class="kw">end</span>]]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    x_data <span class="op">=</span> <span class="fu">Float32</span>.(<span class="fu">cat</span>(clockwise_spirals<span class="op">...</span>, anticlockwise_spirals<span class="op">...</span>; dims<span class="op">=</span><span class="fl">3</span>))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split the dataset</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    (x_train, y_train), (x_val, y_val) <span class="op">=</span> <span class="fu">splitobs</span>((x_data, labels); at<span class="op">=</span><span class="fl">0.8</span>, shuffle<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="fu">DataLoader</span>(<span class="fu">collect</span>.((x_train, y_train)); batchsize<span class="op">=</span><span class="fl">128</span>, shuffle<span class="op">=</span><span class="cn">true</span>),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">DataLoader</span>(<span class="fu">collect</span>.((x_val, y_val)); batchsize<span class="op">=</span><span class="fl">128</span>, shuffle<span class="op">=</span><span class="cn">false</span>))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>get_tutorial_dataloaders (generic function with 1 method)</code></pre>
</div>
</div>
</section>
<section id="configure-the-neural-network" class="level2">
<h2 class="anchored" data-anchor-id="configure-the-neural-network">Configure the Neural Network</h2>
<p>Following from the tutorial in the <a href="https://lux.csail.mit.edu/stable/examples/generated/beginner/SimpleRNN/main/">Lux documentation</a> we write a series of functions that will create our NN.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Lux</span>, <span class="bu">Random</span>, <span class="bu">Optimisers</span>, <span class="bu">Zygote</span>, <span class="bu">NNlib</span>, <span class="bu">Statistics</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We seed the random number generator for consistent results.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="bu">Random</span>.<span class="fu">default_rng</span>()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Random</span>.<span class="fu">seed!</span>(rng, <span class="fl">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>TaskLocalRNG()</code></pre>
</div>
</div>
<p>Define a new <code>struct</code> that extends the <code>Lux</code> <code>Container</code> type and holds the LSTM model and the classifier.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> StateClassifier{L,C} <span class="op">&lt;:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>       Lux.AbstractExplicitContainerLayer{(<span class="op">:</span>lstm_cell, <span class="op">:</span>classifier)}</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    lstm_cell<span class="op">::</span><span class="dt">L</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    classifier<span class="op">::</span><span class="dt">C</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">StateClassifier</span>(in_dims, hidden_dims, out_dims)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">StateClassifier</span>(<span class="fu">LSTMCell</span>(in_dims <span class="op">=&gt;</span> hidden_dims),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Dense</span>(hidden_dims <span class="op">=&gt;</span> out_dims, sigmoid))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>StateClassifier</code></pre>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> (s<span class="op">::</span><span class="dt">StateClassifier</span>)(x<span class="op">::</span><span class="dt">AbstractArray{T,3}</span>, ps<span class="op">::</span><span class="dt">NamedTuple</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    st<span class="op">::</span><span class="dt">NamedTuple</span>) <span class="kw">where</span> {T}</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    x_init, x_rest <span class="op">=</span> <span class="bu">Iterators</span>.<span class="fu">peel</span>(<span class="fu">eachslice</span>(x; dims<span class="op">=</span><span class="fl">2</span>))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    (y, carry), st_lstm <span class="op">=</span> s.<span class="fu">lstm_cell</span>(x_init, ps.lstm_cell, st.lstm_cell)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> x_rest</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        (y, carry), st_lstm <span class="op">=</span> s.<span class="fu">lstm_cell</span>((x, carry), ps.lstm_cell, st_lstm)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    y, st_classifier <span class="op">=</span> s.<span class="fu">classifier</span>(y, ps.classifier, st.classifier)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    st <span class="op">=</span> <span class="fu">merge</span>(st, (classifier<span class="op">=</span>st_classifier, lstm_cell<span class="op">=</span>st_lstm))</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">vec</span>(y), st</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the loss function, using binarycrossentropy for simplicity.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">xlogy</span>(x, y)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> x <span class="op">*</span> <span class="fu">log</span>(y)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">ifelse</span>(<span class="fu">iszero</span>(x), <span class="fu">zero</span>(result), result)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">binarycrossentropy</span>(y_pred, y_true)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> y_pred <span class="op">.+</span> <span class="fu">eps</span>(<span class="fu">eltype</span>(y_pred))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">mean</span>(@. <span class="fu">-xlogy</span>(y_true, y_pred) <span class="op">-</span> <span class="fu">xlogy</span>(<span class="fl">1</span> <span class="op">-</span> y_true, <span class="fl">1</span> <span class="op">-</span> y_pred))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">compute_loss</span>(x, y, model, ps, st)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    y_pred, st <span class="op">=</span> <span class="fu">model</span>(x, ps, st)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">binarycrossentropy</span>(y_pred, y), y_pred, st</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="fu">matches</span>(y_pred, y_true) <span class="op">=</span> <span class="fu">sum</span>((y_pred <span class="op">.&gt;</span> <span class="fl">0.5</span>) <span class="op">.==</span> y_true)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy</span>(y_pred, y_true) <span class="op">=</span> <span class="fu">matches</span>(y_pred, y_true) <span class="op">/</span> <span class="fu">length</span>(y_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>accuracy (generic function with 1 method)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">create_optimiser</span>(ps)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    opt <span class="op">=</span> Optimisers.<span class="fu">ADAM</span>(<span class="fl">0.0001f0</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Optimisers.<span class="fu">setup</span>(opt, ps)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>create_optimiser (generic function with 1 method)</code></pre>
</div>
</div>
</section>
<section id="train-the-nn" class="level2">
<h2 class="anchored" data-anchor-id="train-the-nn">Train the NN</h2>
<p>Now with all of the boilerplate work out of the way, the NN can actually be trained!</p>
<p>From extensive debugging and iteration, it was determined that a <em>very</em> low learning rate was critical for the successful operation of the NN. The number of epochs is set to 55, which is the point at which the change in the loss substantially decreases and the model begins to overfit. The ideal batch size was determined to be 2^6, and substantially higher or lower sizes would cause parabolic loss curves or numerical instability (which can be partially blamed on the loss function).</p>
<p>Begin by loading the data from the file and partition it:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(train_loader, val_loader) <span class="op">=</span> <span class="fu">get_dataloaders</span>(smaller_label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Progress:
 - row 2050 of 3274
 - row 4100 of 3274
 - row 6150 of 3274
downsampled to 6548 samples, 3274 converged 3274 failed
...loading done, partitioning data.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>(DataLoader(::Tuple{Array{Float32, 3}, Vector{Float32}}, shuffle=true, batchsize=64), DataLoader(::Tuple{Array{Float32, 3}, Vector{Float32}}, batchsize=64))</code></pre>
</div>
</div>
<p>Initialize the model and the optimizer (using ADAM):</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">StateClassifier</span>(<span class="fl">60</span>, <span class="fl">6</span>, <span class="fl">1</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="bu">Random</span>.<span class="fu">default_rng</span>()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Random</span>.<span class="fu">seed!</span>(rng, <span class="fl">0</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>ps, st <span class="op">=</span> Lux.<span class="fu">setup</span>(rng, model)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>opt_state <span class="op">=</span> <span class="fu">create_optimiser</span>(ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div class="ansi-escaped-output">
<pre>(lstm_cell = (weight_i = <span class="ansi-green-fg">Leaf(Adam{Float32}(0.0001, (0.9, 0.999), 1.19209f-7), </span>(Float32[0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], Float32[0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], (0.9, 0.999))<span class="ansi-green-fg">)</span>, weight_h = <span class="ansi-green-fg">Leaf(Adam{Float32}(0.0001, (0.9, 0.999), 1.19209f-7), </span>(Float32[0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], Float32[0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], (0.9, 0.999))<span class="ansi-green-fg">)</span>, bias = <span class="ansi-green-fg">Leaf(Adam{Float32}(0.0001, (0.9, 0.999), 1.19209f-7), </span>(Float32[0.0; 0.0; … ; 0.0; 0.0;;], Float32[0.0; 0.0; … ; 0.0; 0.0;;], (0.9, 0.999))<span class="ansi-green-fg">)</span>), classifier = (weight = <span class="ansi-green-fg">Leaf(Adam{Float32}(0.0001, (0.9, 0.999), 1.19209f-7), </span>(Float32[0.0 0.0 … 0.0 0.0], Float32[0.0 0.0 … 0.0 0.0], (0.9, 0.999))<span class="ansi-green-fg">)</span>, bias = <span class="ansi-green-fg">Leaf(Adam{Float32}(0.0001, (0.9, 0.999), 1.19209f-7), </span>(Float32[0.0;;], Float32[0.0;;], (0.9, 0.999))<span class="ansi-green-fg">)</span>))</pre>
</div>
</div>
</div>
<p>And finally, train the model printing the occassional update.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>loss_vector <span class="op">=</span> <span class="dt">Float64</span>[]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>accuracy_vector <span class="op">=</span> <span class="dt">Float64</span>[]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">55</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the model</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    epoch_loss <span class="op">=</span> <span class="dt">Float64</span>[]</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (x, y) <span class="kw">in</span> train_loader</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        (loss, y_pred, st), back <span class="op">=</span> <span class="fu">pullback</span>(p <span class="op">-&gt;</span> <span class="fu">compute_loss</span>(x, y, model, p, st), ps)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        gs <span class="op">=</span> <span class="fu">back</span>((<span class="fu">one</span>(loss), <span class="cn">nothing</span>, <span class="cn">nothing</span>))[<span class="fl">1</span>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        opt_state, ps <span class="op">=</span> Optimisers.<span class="fu">update</span>(opt_state, ps, gs)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(epoch_loss, loss)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    avg_loss <span class="op">=</span> <span class="fu">mean</span>(epoch_loss)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(loss_vector, avg_loss)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate the model</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    epoch_accuracy <span class="op">=</span> <span class="dt">Float64</span>[]</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    st_ <span class="op">=</span> Lux.<span class="fu">testmode</span>(st)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (x, y) <span class="kw">in</span> val_loader</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        (loss, y_pred, st_) <span class="op">=</span> <span class="fu">compute_loss</span>(x, y, model, ps, st_)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        acc <span class="op">=</span> <span class="fu">accuracy</span>(y_pred, y)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(epoch_accuracy, acc)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    avg_accuracy <span class="op">=</span> <span class="fu">mean</span>(epoch_accuracy)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> epoch <span class="op">==</span> <span class="fl">1</span> <span class="op">||</span> <span class="fu">mod</span>(epoch, <span class="fl">5</span>) <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span>(<span class="st">"Epoch # </span><span class="sc">$</span>epoch<span class="st">:</span><span class="sc">\n</span><span class="st"> - loss of </span><span class="sc">$</span>avg_loss<span class="st">"</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span>(<span class="st">" - accuracy of </span><span class="sc">$</span>avg_accuracy<span class="st">"</span>)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">flush</span>(<span class="cn">stdout</span>)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(accuracy_vector, avg_accuracy)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch # 1:
 - loss of 0.7282473619391279
 - accuracy of 0.5146825396825397
Epoch # 5:
 - loss of 0.7089660269458119
 - accuracy of 0.5236111111111111
Epoch # 10:
 - loss of 0.6943259777092352
 - accuracy of 0.5287202380952382
Epoch # 15:
 - loss of 0.686766859961719
 - accuracy of 0.5387896825396825
Epoch # 20:
 - loss of 0.6815697768839394
 - accuracy of 0.5472718253968254
Epoch # 25:
 - loss of 0.6774497729976002
 - accuracy of 0.5570436507936508
Epoch # 30:
 - loss of 0.6739311807039308
 - accuracy of 0.5617063492063492
Epoch # 35:
 - loss of 0.6705420882236667
 - accuracy of 0.5556547619047618
Epoch # 40:
 - loss of 0.6674438722249938
 - accuracy of 0.5660714285714286
Epoch # 45:
 - loss of 0.6641433820491884
 - accuracy of 0.5712797619047618
Epoch # 50:
 - loss of 0.661274130751447
 - accuracy of 0.5734126984126984
Epoch # 55:
 - loss of 0.6587260307335272
 - accuracy of 0.5696924603174602</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(loss_vector, label<span class="op">=</span><span class="st">"loss"</span>, legend<span class="op">=:</span>bottom, color<span class="op">=:</span>red, rightmargin<span class="op">=</span><span class="fl">1.5</span>Plots.cm, bottommargin<span class="op">=</span><span class="fl">0.5</span>Plots.cm, box<span class="op">=:</span>on, fmt<span class="op">=:</span>png)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fu">twinx</span>(), accuracy_vector, label<span class="op">=</span><span class="st">"accuracy"</span>, legend<span class="op">=:</span>top, xlabel<span class="op">=</span><span class="st">"epoch"</span>, rightmargin<span class="op">=</span><span class="fl">1.5</span>Plots.cm, bottommargin<span class="op">=</span><span class="fl">0.5</span>Plots.cm, box<span class="op">=:</span>on)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<p><img src="main_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>While this final accuracy is not outstanding, it is worthwhile for this use case since every successful prediction could save potentially <em>weeks</em> of time. If taken more as a proof of concept, providing a model with only the molecular coordinates and then augmenting the data with electronic descriptors retrived from the same calculations was able to dramatically improve the results. In the future, more descriptors could be added to further increase the performance, or alternative network architectures could be explored.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Dates</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>timestamp <span class="op">=</span> <span class="fu">now</span>()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">savefig</span>(<span class="st">"results/result-</span><span class="sc">$</span>timestamp<span class="st">.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>